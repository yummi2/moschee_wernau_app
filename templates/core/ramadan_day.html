{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="mx-auto max-w-5xl px-4 mt-8" dir="rtl">
  <div class="bg-white rounded-2xl shadow p-6 relative overflow-hidden">

    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-bold text-blue-800">{{ title }}</h2>
    </div>

    <div class="text-center mb-8">

      {# ✅ Card-Overlay #}
      <div id="card-overlay"
           class="absolute inset-0 z-40 hidden items-center justify-center bg-white/90 backdrop-blur-sm">
        <div class="text-center">
          <div id="lottie-success" class="mx-auto w-64 h-64"></div>

          <div id="overlay-msg"
               class="mt-2 text-xl font-semibold text-red-600 hidden"></div>
        </div>
      </div>

      <h3 class="text-xl font-bold text-blue-800 mb-2">{{ item_title }}</h3>

      {% if current_image %}
        <img src="{{ current_image }}" alt="{{ item_title }}"
             class="mx-auto w-64 h-64 object-contain rounded-xl mb-4">
      {% endif %}

      <div class="text-lg leading-loose whitespace-pre-line">
        {{ current_text|safe }}
      </div>

      <div class="mt-6 flex items-center justify-between">
        {% if prev_href %}
          <a href="{{ prev_href }}" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">السابق</a>
        {% else %}
          <span class="px-4 py-2 rounded-xl bg-gray-100 text-gray-400 cursor-not-allowed">السابق</span>
        {% endif %}

        {% if next_href %}
          <a href="{{ next_href }}" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">
            التالي
          </a>
        {% else %}
          <button id="final-btn"
                  data-show-success="{{ show_success|yesno:'1,0' }}"
                  class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">
            التالي
          </button>
        {% endif %}
      </div>

      {% if p == total %}
        <div class="mt-6">
          {% if already_done %}
            <button id="mark-done-btn" class="px-4 py-2 rounded bg-green-600 text-white cursor-default" disabled>
              ✅ تمّ
            </button>
          {% else %}
            <button id="mark-done-btn" class="px-4 py-2 rounded bg-purple-600 text-white">
              تم
            </button>
          {% endif %}
          <p id="mark-done-msg" class="mt-2 text-sm text-gray-600"></p>
        </div>
      {% endif %}

    </div>
  </div>
</div>

{# ✅ Lottie nur EINMAL #}
<script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>

<script>
function playSuccessAnimation() {
  const el = document.getElementById("lottie-success");
  if (!el) return;

  // immer neu starten
  el.innerHTML = "";

  lottie.loadAnimation({
    container: el,
    renderer: "svg",
    loop: false,
    autoplay: true,
    path: "https://res.cloudinary.com/drlpkuf9q/raw/upload/v1769941328/USA_confetti_wlbidw.json"
  });
}

(function () {
  const finalBtn = document.getElementById("final-btn");
  if (!finalBtn) return;

  const overlay = document.getElementById("card-overlay");
  const msg = document.getElementById("overlay-msg");
  const closeBtn = document.getElementById("close-overlay");

  function openOverlay() {
    overlay.classList.remove("hidden");
    overlay.classList.add("flex");
  }
  function closeOverlay() {
    overlay.classList.add("hidden");
    overlay.classList.remove("flex");
  }

  finalBtn.addEventListener("click", function () {
    const showSuccess = finalBtn.dataset.showSuccess === "1";
    openOverlay();

    if (!showSuccess) {
      msg.classList.remove("hidden");
      msg.textContent = "أكمل كل المهام أولاً";
      return;
    }

    msg.classList.add("hidden");
    playSuccessAnimation();

    finalBtn.disabled = true;
    finalBtn.classList.add("opacity-50", "cursor-not-allowed");
  });

  closeBtn.addEventListener("click", closeOverlay);

  // Klick auf Hintergrund schließt
  overlay.addEventListener("click", function (e) {
    if (e.target === overlay) closeOverlay();
  });
})();
</script>

<script>
(function () {
  const btn = document.getElementById('mark-done-btn');
  if (!btn) return;

  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  btn.addEventListener('click', async function () {
    if (btn.disabled) return;
    btn.disabled = true;

    try {
      const res = await fetch("{% url 'mark_ramadan_item_done' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({
          day: {{ day }},
          item_key: "{{ item_key }}"
        })
      });

      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error("Request failed");

      btn.textContent = "✅ تمّ";
      btn.classList.remove("bg-purple-600");
      btn.classList.add("bg-green-600");
      document.getElementById('mark-done-msg').textContent = "تم";
    } catch (e) {
      btn.disabled = false;
      document.getElementById('mark-done-msg').textContent = "حدث خطأ، حاول مرة أخرى.";
      console.error(e);
    }
  });
})();
</script>
{% endblock %}
