{% extends "base.html" %}
{% load extras %}
{% block title %}Ø¯Ø§Ø± Ø§Ù„ÙØ±Ø­ {% endblock %}
{% block content %}

<div class="mx-auto max-w-6xl px-4">
    <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_18rem] items-start">
        <main class="space-y-6">

            <div class="bg-white rounded-2xl shadow p-6" dir="rtl">
                {% if user.is_authenticated %}
                <h2 class="text-2xl font-semibold mb-4 text-black-600">
                    Ù…Ø±Ø­Ø¨Ù‹Ø§ {{ user.username }}
                </h2>

                {% with active_tab=request.GET.tab|default:"assignments" %}
                <div class="flex gap-2 mb-2">
                    <a href="?tab=assignments" class="px-3 py-1 rounded-lg border
           {% if active_tab == 'assignments' %} bg-blue-600 text-white border-blue-600
           {% else %} text-blue-700 hover:bg-blue-50 border-blue-200 {% endif %}">
                        ÙˆØ§Ø¬Ø¨Ø§ØªÙƒ
                    </a>

                    <a href="?tab=notes" class="px-3 py-1 rounded-lg border
           {% if active_tab == 'notes' %} bg-blue-600 text-white border-blue-600
           {% else %} text-blue-700 hover:bg-blue-50 border-blue-200 {% endif %}">
                        Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                    </a>

                    {% if not is_teacher %}
                    <a href="?tab=checklist" class="px-3 py-1 rounded-lg border
           {% if active_tab == 'checklist' %} bg-blue-600 text-white border-blue-600
           {% else %} text-blue-700 hover:bg-blue-50 border-blue-200 {% endif %}">
                        Ù…Ø§ ØªÙ… ØªØ³Ù…ÙŠØ¹Ù‡
                    </a>
                    {% endif %}
                    <a href="?tab=prayer"
                    class="px-3 py-1 rounded-lg border
                    {% if active_tab == 'prayer' %} bg-blue-600 text-white border-blue-600
                    {% else %} text-blue-700 hover:bg-blue-50 border-blue-200 {% endif %}">
                        Ø§Ù„ØµÙ„Ø§Ø©
                    </a>

                </div>

                {# --- Inhalt: Hausaufgaben --- #}
                <div class="mt-4 {% if active_tab != 'assignments' %}hidden{% endif %}">
                    {% if user.is_authenticated and assignments %}
                    <ul class="space-y-3">
                        {% for a in assignments %}
                        <li class="p-4 border rounded-xl" dir="rtl">
                            {% if a.title %}<p class="font-medium">{{ a.title }}</p>{% endif %}
                            <div class="text-sm text-gray-600">
                                Ø§Ù„Ù…Ø¹Ù„Ù…: {{ a.created_by.get_full_name|default:a.created_by.username }}
                                | Ø§Ù„ØµÙ: {{ a.classroom.name }}
                                | Ø§Ù„ØªØ§Ø±ÙŠØ®: {{ a.created_at|date:"d.m.Y" }}
                            </div>
                            {% if a.description %}<p class="text-red-600">{{ a.description }}</p>{% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-gray-600">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ§Ø¬Ø¨Ø§Øª (Ø±Ø¨Ù…Ø§ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ùƒ Ø¥Ù„Ù‰ ØµÙ Ø¨Ø¹Ø¯).</p>
                    {% endif %}
                </div>

                {# --- Inhalt: Notizen --- #}
                <div class="mt-4 {% if active_tab != 'notes' %}hidden{% endif %}">
                    {% if teacher_notes and teacher_notes|length > 0 %}
                    <ul class="space-y-3">
                        {% for n in teacher_notes %}
                        <li class="p-3 border rounded-xl">
                            <div class="text-sm text-gray-600 mb-1">
                                {% if is_teacher %}
                                Ø¥Ù„Ù‰: <span
                                    class="font-medium">{{n.student.get_full_name|default:n.student.username}}</span>
                                {% else %}
                                Ù…Ù†: <span
                                    class="font-medium">{{n.teacher.get_full_name|default:n.teacher.username}}</span>
                                {% endif %}
                                {% if n.classroom %} â€” Ø§Ù„ØµÙ: {{ n.classroom.name }}{% endif %}
                                â€” <span dir="ltr">{{ n.created_at|date:"d.m.Y H:i" }}</span>
                            </div>
                            <p class="text-gray-900">{{ n.body|linebreaksbr }}</p>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</p>
                    {% endif %}
                </div>


                <!-- --- Inhalt: Ù…Ø§ ØªÙ… ØªØ³Ù…ÙŠØ¹Ù‡ (Checkliste) --- -->
                {% if not is_teacher %}
                <div class="mt-4 {% if active_tab != 'checklist' %}hidden{% endif %}">
                    <h4 class="font-semibold text-blue-700 mb-3">Ù…Ø§ ØªÙ… ØªØ³Ù…ÙŠØ¹Ù‡</h4>
                    {% if checklist_items %}
                    <ul class="space-y-2">
                        {% for it in checklist_items %}
                        <li class="flex items-center gap-2">
                            <input type="checkbox" disabled {% if it.id in checked_item_ids %}checked{% endif %}>
                            <label>{{ it.title }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</p>
                    {% endif %}
                </div>
                {# --- Inhalt: Ø§Ù„ØµÙ„Ø§Ø© --- #}
                <div class="mt-4 {% if active_tab != 'prayer' %}hidden{% endif %}">
                    <h4 class="font-semibold text-blue-700 mb-3">
                        ØµÙ„ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…
                    </h4>

                    <div class="flex justify-center gap-3 text-3xl mb-4">
                        {% for i in "12345" %}
                        <span
                            class="prayer-star cursor-pointer
                            {% if prayer_stars >= forloop.counter %}
                                text-blue-400
                            {% else %}
                                text-gray-300
                            {% endif %}"
                            data-star="{{ forloop.counter }}"
                            data-date="{{ cal_year }}-{{ cal_month|stringformat:'02d' }}-{{ cal_today.day|stringformat:'02d' }}"
                        >
                        â˜…
                        </span>
                        {% endfor %}
                    </div>

                <p class="text-center text-sm text-gray-600">
                    Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø©
                </p>
            </div>
                {% endif %}

                {% endwith %}
                {% else %}
                <h2 class="text-2xl font-semibold mb-4 text-black-600">Ù…Ø±Ø­Ø¨Ù‹Ø§</h2>
                <p class="text-gray-600 text-lg">2025 / 2026</p>
                {% endif %}
            </div>
        </main>

        {% if request.user.is_authenticated %}
        <aside class="bg-white rounded-2xl shadow p-4 lg:sticky lg:top-20 max-h-[80vh] overflow-auto w-full" dir="rtl">


            <ul class="space-y-3">
                <li>
                    <form method="post" action="{% url 'profile' %}" enctype="multipart/form-data" class="text-center">
                        {% csrf_token %}
                        <label for="avatarInput"
                            class="block w-16 h-16 mx-auto rounded-full overflow-hidden border shadow cursor-pointer">
                            {% if request.user.profile.avatar %}
                            <img src="{{ request.user.profile.avatar.url }}" class="w-full h-full object-cover"
                                alt="avatar">
                            {% else %}
                            <div class="w-full h-full grid place-items-center bg-gray-200 text-gray-600">
                                {{ request.user.username|first|upper }}
                            </div>
                            {% endif %}
                        </label>
                        <input type="file" id="avatarInput" name="avatar" accept="image/*" class="hidden"
                            onchange="this.form.submit()">
                    </form>
                </li>

                <li>
                    <p class="mt-3 text-center text-sm">{{ request.user.username }}</p>
                </li>
                <li><a href="{% url 'profile' %}" class="text-blue-600 hover:underline">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</a></li>

                <li class="mt-6">
                    <form id="csrf-helper" style="display:none;">{% csrf_token %}</form>

                    <div class="flex justify-between items-center mb-2">
                        <a href="?y={{ cal_next_y }}&m={{ cal_next_m }}" class="text-blue-600">&rarr;</a>
                        <span class="font-semibold text-blue-700">{{ cal_month_name }} {{ cal_year }}</span>
                        <a href="?y={{ cal_prev_y }}&m={{ cal_prev_m }}" class="text-blue-600">&larr;</a>
                    </div>

                    <table class="w-full text-center text-sm sm:text-xs">
                        <thead>
                            <tr>
                                {% for d in cal_weekday_names %}
                                <th class="py-1 text-gray-500">{{ d }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for week in cal_weeks %}
                            <tr>
                                {% for day in week %}
                                {% if day == 0 %}
                                <td class="py-1"></td>
                                {% else %}
                                <td class="py-1">
                                    <button type="button" class="cal-day px-2 py-1 min-w-[44px] min-h-[44px] rounded
                     {% if day in absences %} bg-red-600 text-white is-absent
                     {% elif special_map|dict_get:day %} {{ special_map|dict_get:day }}
                     {% endif %}
                     {% if day in purple_days and day not in absences %} is-purple{% endif %}"
                                        data-date="{{ cal_year }}-{{ cal_month|stringformat:'02d' }}-{{ day|stringformat:'02d' }}"
                                        {% if day not in purple_days or day in absences %}disabled{% endif %}>
                                        <span
                                            class="{% if day == cal_today.day and cal_month == cal_today.month and cal_year == cal_today.year %} ring-2 ring-blue-600 rounded {% endif %}">
                                            {{ day }}
                                        </span>
                                    </button>
                                </td>
                                {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="mt-3 space-y-1 text-xs" dir="rtl">
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-purple-600"></span>
                            <span>Ø¯ÙˆØ§Ù…</span>
                        </div>

                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-blue-600"></span>
                            <span>Ø§Ù„ÙŠÙˆÙ…</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-green-500"></span>
                            <span>Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-blue-300 text-gray-900"></span>
                            <span>Ø¹Ø·Ù„Ø© Ø§Ù„Ø¹ÙŠØ¯</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-pink-300 text-gray-900"></span>
                            <span>Ø§Ù„Ø­ÙÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-red-600"></span>
                            <span>Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª: <b id="absencesCount">{{ absences_total }}</b></span>
                        </div>
                    </div>

                    <script>
                        function initMiniCalendar() {
                            function getCsrfFromCookie() {
                                const m = document.cookie.match(/csrftoken=([^;]+)/);
                                return m ? m[1] : null;
                            }
                            const csrfToken =
                                (document.querySelector('#csrf-helper input[name=csrfmiddlewaretoken]') || {}).value ||
                                getCsrfFromCookie();

                            document.querySelectorAll("button.cal-day").forEach((btn) => {
                                const isPurple = btn.classList.contains("is-purple");
                                const isAbsent = btn.classList.contains("is-absent");
                                const isDisabledAttr = btn.hasAttribute("disabled");
                                btn.style.cursor = isPurple && !isAbsent && !isDisabledAttr ? "pointer" : "default";

                                btn.addEventListener("click", async () => {
                                    if (!btn.classList.contains("is-purple") || btn.classList.contains("is-absent") || btn.disabled) return;

                                    const date = btn.dataset.date;
                                    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© ØºÙŠØ§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…ØŸ")) return;

                                    try {
                                        const resp = await fetch("{% url 'mark_absence' %}", {
                                            method: "POST",
                                            headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken || "" },
                                            body: JSON.stringify({ date }),
                                        });

                                        let data = {};
                                        try { data = await resp.json(); } catch (_) { }
                                        console.log("mark_absence response:", resp.status, data);

                                        if (!resp.ok) {
                                            alert(data.error || "ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨.");
                                            return;
                                        }

                                        // Erfolg: Lila -> Rot
                                        btn.classList.remove("bg-purple-600", "is-purple");
                                        btn.classList.add("bg-red-600", "text-white", "is-absent");
                                        btn.disabled = true;
                                        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨Ùƒ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….");
                                        const countEl = document.getElementById("absencesCount");
                                        if (countEl && typeof data.total === "number") {
                                            countEl.textContent = String(data.total);
                                        }
                                    } catch (e) {
                                        console.error(e);
                                        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.");
                                    }
                                });
                            });
                        }
                        if (document.readyState === "loading") {
                            document.addEventListener("DOMContentLoaded", initMiniCalendar);
                        } else {
                            initMiniCalendar();
                        }
                    </script>
                </li>
            </ul>


        </aside>
        {% endif %}

    </div>
</div>
            <script>
            document.addEventListener("DOMContentLoaded", () => {
                function getCsrfFromCookie() {
                    const m = document.cookie.match(/csrftoken=([^;]+)/);
                    return m ? m[1] : "";
                }

                const csrfToken = getCsrfFromCookie();
                const stars = document.querySelectorAll(".prayer-star");

                stars.forEach(star => {
                    star.addEventListener("click", async () => {
                        const selected = parseInt(star.dataset.star, 10);
                        const date = star.dataset.date;

                        // ğŸ”µ Farbe sofort setzen
                        stars.forEach(s => {
                            const val = parseInt(s.dataset.star, 10);
                            s.classList.toggle("text-blue-400", val <= selected);
                            s.classList.toggle("text-gray-300", val > selected);
                        });

                        // ğŸ’¾ Backend speichern
                        await fetch("{% url 'toggle_prayer_star' %}", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": csrfToken
                            },
                            body: JSON.stringify({
                                date: date,
                                stars: selected
                            })
                        });
                    });
                });
            });
            </script>


{% endblock %}