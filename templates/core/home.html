{% extends "base.html" %}
{% load extras %}
{% block title %}دار الفرح {% endblock %}
{% block content %}

<div class="mx-auto max-w-6xl px-4">
    <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_18rem] items-start">
        <main class="space-y-6">

            <div class="bg-white rounded-2xl shadow p-6" dir="rtl">
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">مرحبًا {{ user.username }}</h2>

                {% if user.is_authenticated %}
                {% if assignments %}
                <h3 class="font-semibold mb-2">واجباتك</h3>
                <ul class="space-y-3">
                    {% for a in assignments %}
                    <li class="p-4 border rounded-xl" dir="rtl">
                        <div class="font-medium">
                            <a class="text-blue-600">
                                {{ a.title }}
                            </a>
                        </div>
                        <div class="text-sm text-gray-600">
                            الصف: {{ a.classroom.name }} 
                        </div>
                        {% if a.description %}<p class="mt-2 text-gray-700">{{ a.description }}</p>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-gray-600">لا توجد واجبات (ربما لم يتم تعيينك إلى صف بعد).</p>
                {% endif %}
                {% else %}
                <p class="text-gray-600">2025/2026</p>
                {% endif %}

            </div>
        </main>

        {% if request.user.is_authenticated %}
        <aside class="bg-white rounded-2xl shadow p-4 lg:sticky lg:top-20 max-h-[80vh] overflow-auto w-full" dir="rtl">


            <ul class="space-y-3">
                <li>
                    <form method="post" action="{% url 'profile' %}" enctype="multipart/form-data" class="text-center">
                        {% csrf_token %}
                        <label for="avatarInput"
                            class="block w-16 h-16 mx-auto rounded-full overflow-hidden border shadow cursor-pointer">
                            {% if request.user.profile.avatar %}
                            <img src="{{ request.user.profile.avatar.url }}" class="w-full h-full object-cover"
                                alt="avatar">
                            {% else %}
                            <div class="w-full h-full grid place-items-center bg-gray-200 text-gray-600">
                                {{ request.user.username|first|upper }}
                            </div>
                            {% endif %}
                        </label>
                        <input type="file" id="avatarInput" name="avatar" accept="image/*" class="hidden"
                            onchange="this.form.submit()">
                    </form>
                </li>

                <li>
                    <p class="mt-3 text-center text-sm">{{ request.user.username }}</p>
                </li>
                <li><a href="{% url 'profile' %}" class="text-blue-600 hover:underline">الصفحة الشخصية</a></li>

                <li class="mt-6">
                    <form id="csrf-helper" style="display:none;">{% csrf_token %}</form>

                    <div class="flex justify-between items-center mb-2">
                        <a href="?y={{ cal_prev_y }}&m={{ cal_prev_m }}" class="text-blue-600">&larr;</a>
                        <span class="font-semibold text-blue-700">{{ cal_month_name }} {{ cal_year }}</span>
                        <a href="?y={{ cal_next_y }}&m={{ cal_next_m }}" class="text-blue-600">&rarr;</a>
                    </div>

                    <table class="w-full text-center text-xs">
                        <thead>
                            <tr>
                                {% for d in cal_weekday_names %}
                                <th class="py-1 text-gray-500">{{ d }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for week in cal_weeks %}
                            <tr>
                                {% for day in week %}
                                {% if day == 0 %}
                                <td class="py-1"></td>
                                {% else %}
                                <td class="py-1">
                                    <button type="button" class="cal-day px-2 py-1 rounded
                     {% if day in absences %} bg-red-600 text-white is-absent
                     {% elif special_map|dict_get:day %} {{ special_map|dict_get:day }}
                     {% endif %}
                     {% if day in purple_days and day not in absences %} is-purple{% endif %}"
                                        data-date="{{ cal_year }}-{{ cal_month|stringformat:'02d' }}-{{ day|stringformat:'02d' }}"
                                        {% if day not in purple_days or day in absences %}disabled{% endif %}>
                                        <span
                                            class="{% if day == cal_today.day and cal_month == cal_today.month and cal_year == cal_today.year %} ring-2 ring-blue-600 rounded {% endif %}">
                                            {{ day }}
                                        </span>
                                    </button>
                                </td>
                                {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="mt-3 space-y-1 text-xs" dir="rtl">
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-purple-600"></span>
                            <span>دوام</span>
                        </div>

                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-blue-600"></span>
                            <span>اليوم</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-green-500"></span>
                            <span>العطل الرسمية</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-blue-300 text-gray-900"></span>
                            <span>عطلة العيد</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-pink-300 text-gray-900"></span>
                            <span>الحفل النهائي</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3.5 h-3.5 rounded bg-red-600"></span>
                            <span>عدد الغيابات: <b id="absencesCount">{{ absences_total }}</b></span>
                        </div>
                    </div>

                    <script>
                        function initMiniCalendar() {
                            function getCsrfFromCookie() {
                                const m = document.cookie.match(/csrftoken=([^;]+)/);
                                return m ? m[1] : null;
                            }
                            const csrfToken =
                                (document.querySelector('#csrf-helper input[name=csrfmiddlewaretoken]') || {}).value ||
                                getCsrfFromCookie();

                            document.querySelectorAll("button.cal-day").forEach((btn) => {
                                const isPurple = btn.classList.contains("is-purple");
                                const isAbsent = btn.classList.contains("is-absent");
                                const isDisabledAttr = btn.hasAttribute("disabled");
                                btn.style.cursor = isPurple && !isAbsent && !isDisabledAttr ? "pointer" : "default";

                                btn.addEventListener("click", async () => {
                                    if (!btn.classList.contains("is-purple") || btn.classList.contains("is-absent") || btn.disabled) return;

                                    const date = btn.dataset.date;
                                    if (!confirm("هل تريد وضع علامة غياب لهذا اليوم؟")) return;

                                    try {
                                        const resp = await fetch("{% url 'mark_absence' %}", {
                                            method: "POST",
                                            headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken || "" },
                                            body: JSON.stringify({ date }),
                                        });

                                        let data = {};
                                        try { data = await resp.json(); } catch (_) { }
                                        console.log("mark_absence response:", resp.status, data);

                                        if (!resp.ok) {
                                            alert(data.error || "تعذر تنفيذ الطلب.");
                                            return;
                                        }

                                        // Erfolg: Lila -> Rot
                                        btn.classList.remove("bg-purple-600", "is-purple");
                                        btn.classList.add("bg-red-600", "text-white", "is-absent");
                                        btn.disabled = true;
                                        alert("تم تسجيل غيابك لهذا اليوم.");
                                        const countEl = document.getElementById("absencesCount");
                                        if (countEl && typeof data.total === "number") {
                                            countEl.textContent = String(data.total);
                                        }
                                    } catch (e) {
                                        console.error(e);
                                        alert("حدث خطأ غير متوقع.");
                                    }
                                });
                            });
                        }
                        if (document.readyState === "loading") {
                            document.addEventListener("DOMContentLoaded", initMiniCalendar);
                        } else {
                            initMiniCalendar();
                        }
                    </script>
                </li>
            </ul>

        </aside>
        {% endif %}

    </div>
</div>
{% endblock %}